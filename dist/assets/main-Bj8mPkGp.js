var E=Object.defineProperty;var S=(l,e,t)=>e in l?E(l,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[e]=t;var r=(l,e,t)=>S(l,typeof e!="symbol"?e+"":e,t);import{a as d,V as b,C as f,U as C,W as P,S as A,b as V,B}from"./webgpu-core-BonuPhFa.js";import{R as I}from"./render-RqA89sFd.js";import{v as x,a as T,b as U,m as F,c as H,e as z,g as G}from"./math-VtwH4u7w.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class L{constructor(){r(this,"currentMode","horizon-720");r(this,"modeIndex",0);r(this,"godView",{yaw:0,pitch:.35,distance:d.GOD_VIEW_DISTANCE});r(this,"mouse",{down:!1,lastX:0,lastY:0});r(this,"modeChangeCallback",null);this.setupEventListeners()}setupEventListeners(){}attachToCanvas(e){e.addEventListener("mousedown",t=>{this.mouse.down=!0,this.mouse.lastX=t.clientX,this.mouse.lastY=t.clientY}),window.addEventListener("mouseup",()=>{this.mouse.down=!1}),window.addEventListener("mousemove",t=>{if(!this.mouse.down||this.currentMode!=="god")return;const s=t.clientX-this.mouse.lastX,i=t.clientY-this.mouse.lastY;this.godView.yaw+=s*.004,this.godView.pitch=Math.max(-1.4,Math.min(1.4,this.godView.pitch-i*.004)),this.mouse.lastX=t.clientX,this.mouse.lastY=t.clientY}),e.addEventListener("wheel",t=>{this.currentMode==="god"&&(this.godView.distance=Math.max(d.GOD_VIEW_MIN_DISTANCE,Math.min(d.GOD_VIEW_MAX_DISTANCE,this.godView.distance+t.deltaY*10)))})}setViewMode(e){switch(this.modeIndex=e,e){case 0:this.currentMode="horizon-720";break;case 1:this.currentMode="god";break;case 2:this.currentMode="sat-pov";break;default:this.currentMode="horizon-720"}const t=b[e]||b[0];this.modeChangeCallback&&this.modeChangeCallback(this.currentMode,t.name,t.altitude)}getViewMode(){return this.currentMode}getViewModeIndex(){return this.modeIndex}calculateCamera(e,t,s){switch(this.currentMode){case"horizon-720":return this.calculateHorizonView();case"god":return this.calculateGodView();case"sat-pov":return this.calculateFleetPOV(e,t,s);default:return this.calculateHorizonView()}}calculateHorizonView(){return{position:[f.CAMERA_RADIUS_KM,0,0],target:[f.CAMERA_RADIUS_KM,3e3,0],up:[1,0,0],fov:d.DEFAULT_FOV,near:d.NEAR_PLANE,far:d.FAR_PLANE}}calculateGodView(){const{yaw:e,pitch:t,distance:s}=this.godView,i=Math.cos(t),n=Math.sin(t),a=Math.cos(e),h=Math.sin(e),m=[i*a*s,i*h*s,n*s];let u=[0,0,1];return Math.abs(t)>1.35&&(u=[Math.cos(e),Math.sin(e),0]),{position:m,target:[0,0,0],up:u,fov:d.DEFAULT_FOV,near:d.NEAR_PLANE,far:d.FAR_PLANE}}calculateFleetPOV(e,t,s){const i=e(0,s),n=t(0,s),a=x(i),h=T(i,U(a,15)),m=T(h,n);return{position:h,target:m,up:a,fov:d.DEFAULT_FOV,near:1,far:d.FAR_PLANE}}buildViewProjection(e,t){const s=F(e.position,e.target,e.up),i=H(e.fov,t,e.near,e.far),n=new Float32Array(16);for(let a=0;a<4;a++)for(let h=0;h<4;h++){let m=0;for(let u=0;u<4;u++)m+=i[h+u*4]*s[u+a*4];n[h+a*4]=m}return{view:s,projection:i,viewProjection:n}}getCameraAxes(e){return{right:[e[0],e[4],e[8]],up:[e[1],e[5],e[9]]}}onModeChange(e){this.modeChangeCallback=e}resetGodView(){this.godView={yaw:0,pitch:.35,distance:d.GOD_VIEW_DISTANCE}}getViewModes(){return b}}class R{constructor(){r(this,"elements");r(this,"onViewChange",null);this.elements=this.getElements(),this.setupEventListeners()}getElements(){const e=t=>document.getElementById(t);return{altitude:e("s-alt"),fleet:e("s-fleet"),fps:e("s-fps"),viewMode:e("s-view"),visible:e("s-visible"),error:e("error"),controls:e("controls"),buttons:[document.getElementById("btn0"),document.getElementById("btn1"),document.getElementById("btn2")],horizonIndicator:e("horizon-indicator")}}setupEventListeners(){this.elements.buttons.forEach((e,t)=>{e.addEventListener("click",()=>{this.setActiveButton(t),this.onViewChange&&this.onViewChange(t)})})}setActiveButton(e){this.elements.buttons.forEach((t,s)=>{t.classList.toggle("active",s===e)})}setViewMode(e,t){this.elements.viewMode.textContent=`View     : ${e}`,this.elements.altitude.textContent=`Altitude : ${t} km`,e==="720km Horizon"?this.elements.horizonIndicator.style.display="block":this.elements.horizonIndicator.style.display="none"}setFPS(e){this.elements.fps.textContent=`FPS      : ${e}`}setFleetCount(e){this.elements.fleet.textContent=`Fleet    : ${e.toLocaleString()}`}setVisibleCount(e){this.elements.visible.textContent=`Visible  : ${e.toLocaleString()}`}updateStats(e){this.setFPS(e.fps),this.setVisibleCount(e.visibleSatellites)}showError(e){this.elements.error.style.display="block",this.elements.error.innerHTML=`<b>WebGPU Error</b><br>${e}`}hideError(){this.elements.error.style.display="none"}onViewModeChange(e){this.onViewChange=e}getButtons(){return this.elements.buttons}static createUI(){return`
      <div id="ui">
        <div class="title">â—ˆ GROK ZEPHYR</div>
        <div class="stat" id="s-alt">Altitude : 720 km</div>
        <div class="stat" id="s-fleet">Fleet    : 1,048,576</div>
        <div class="stat" id="s-fps">FPS      : --</div>
        <div class="stat" id="s-view">View     : 720km Horizon</div>
        <div class="stat" id="s-visible">Visible  : --</div>
      </div>
      <div id="controls">
        <button class="vbtn active" id="btn0">720km HORIZON</button>
        <button class="vbtn" id="btn1">GOD VIEW</button>
        <button class="vbtn" id="btn2">FLEET POV</button>
      </div>
      <div id="horizon-indicator">
        <div>Earth Radius: 6,371 km</div>
        <div>Orbit Altitude: 550 km</div>
        <div>Camera Altitude: 720 km</div>
        <div>Horizon Distance: ~2,970 km</div>
      </div>
      <div id="error"></div>
    `}}class _{constructor(e={}){r(this,"options");r(this,"frameCount",0);r(this,"lastFpsTime",0);r(this,"currentFps",0);r(this,"lastFrameTime",0);r(this,"frameTimeHistory");r(this,"device",null);r(this,"supportsGPUTiming",!1);r(this,"timingQuery",null);r(this,"pendingQueries",0);r(this,"computeTimeHistory");r(this,"renderTimeHistory");r(this,"visibleSatellites",0);r(this,"gpuMemoryMB",0);r(this,"statsCallback",null);this.options={enableGPUTiming:!0,historySize:60,fpsUpdateInterval:C.FPS_UPDATE_INTERVAL,...e},this.frameTimeHistory=this.createHistory(this.options.historySize),this.computeTimeHistory=this.createHistory(this.options.historySize),this.renderTimeHistory=this.createHistory(this.options.historySize)}async initialize(e){this.device=e;const t=await navigator.gpu.requestAdapter();this.supportsGPUTiming=(t==null?void 0:t.features.has("timestamp-query"))??!1,this.supportsGPUTiming&&this.options.enableGPUTiming&&this.initializeGPUTiming(),console.log(`[PerformanceProfiler] GPU timing: ${this.supportsGPUTiming?"enabled":"disabled"}`)}initializeGPUTiming(){if(!this.device)return;const e=this.device.createQuerySet({type:"timestamp",count:4}),t=this.device.createBuffer({size:4*8,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC});this.timingQuery={querySet:e,resolveBuffer:t,resultBuffer:null,startIndex:0,endIndex:1}}beginFrame(e){this.lastFrameTime=e}endFrame(e){const t=e*.001,s=e-this.lastFrameTime;this.addToHistory(this.frameTimeHistory,s),this.frameCount++;const i=t-this.lastFpsTime;if(i>=this.options.fpsUpdateInterval){this.currentFps=Math.round(this.frameCount/i),this.frameCount=0,this.lastFpsTime=t,this.updateGPUMemory();const n={fps:this.currentFps,frameTime:this.getAverage(this.frameTimeHistory),gpuMemoryMB:this.gpuMemoryMB,visibleSatellites:this.visibleSatellites,computeTime:this.getAverage(this.computeTimeHistory),renderTime:this.getAverage(this.renderTimeHistory)};return this.statsCallback&&this.statsCallback(n),n}return null}recordComputeTime(e){this.addToHistory(this.computeTimeHistory,e)}recordRenderTime(e){this.addToHistory(this.renderTimeHistory,e)}setVisibleSatellites(e){this.visibleSatellites=e}setGPUMemoryMB(e){this.gpuMemoryMB=e}onStatsUpdate(e){this.statsCallback=e}getStats(){return{fps:this.currentFps,frameTime:this.getAverage(this.frameTimeHistory),gpuMemoryMB:this.gpuMemoryMB,visibleSatellites:this.visibleSatellites,computeTime:this.getAverage(this.computeTimeHistory),renderTime:this.getAverage(this.renderTimeHistory)}}beginGPUPass(e,t){if(!this.timingQuery||!this.supportsGPUTiming)return;const s=t==="compute"?0:2;e.writeTimestamp(this.timingQuery.querySet,s)}endGPUPass(e,t){if(!this.timingQuery||!this.supportsGPUTiming)return;const s=t==="compute"?1:3;e.writeTimestamp(this.timingQuery.querySet,s)}resolveTimestamps(e){!this.timingQuery||!this.supportsGPUTiming||(e.resolveQuerySet(this.timingQuery.querySet,0,4,this.timingQuery.resolveBuffer,0),this.timingQuery.resultBuffer||(this.timingQuery.resultBuffer=this.device.createBuffer({size:4*8,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ})),e.copyBufferToBuffer(this.timingQuery.resolveBuffer,0,this.timingQuery.resultBuffer,0,4*8),this.pendingQueries++)}async readbackTimestamps(){var n;if(!((n=this.timingQuery)!=null&&n.resultBuffer)||this.pendingQueries===0)return;const e=this.timingQuery.resultBuffer;await e.mapAsync(GPUMapMode.READ);const t=new BigInt64Array(e.getMappedRange()),s=Number(t[1]-t[0])/1e6,i=Number(t[3]-t[2])/1e6;e.unmap(),s>0&&s<1e3&&this.addToHistory(this.computeTimeHistory,s),i>0&&i<1e3&&this.addToHistory(this.renderTimeHistory,i),this.pendingQueries--}updateGPUMemory(){const e=performance;if(e.memory){const t=e.memory.usedJSHeapSize/1024/1024;this.gpuMemoryMB=Math.max(this.gpuMemoryMB,t)}}createHistory(e){return{values:[],maxSize:e,sum:0}}addToHistory(e,t){e.values.length>=e.maxSize&&(e.sum-=e.values.shift()),e.values.push(t),e.sum+=t}getAverage(e){return e.values.length===0?0:e.sum/e.values.length}reset(){this.frameCount=0,this.lastFpsTime=0,this.currentFps=0,this.frameTimeHistory=this.createHistory(this.options.historySize),this.computeTimeHistory=this.createHistory(this.options.historySize),this.renderTimeHistory=this.createHistory(this.options.historySize),this.visibleSatellites=0}destroy(){var e;this.timingQuery&&(this.timingQuery.querySet.destroy(),this.timingQuery.resolveBuffer.destroy(),(e=this.timingQuery.resultBuffer)==null||e.destroy(),this.timingQuery=null),this.device=null}}class O{constructor(){r(this,"canvas");r(this,"context",null);r(this,"buffers",null);r(this,"pipeline",null);r(this,"camera");r(this,"ui");r(this,"profiler");r(this,"earthVertexBuffer",null);r(this,"earthIndexBuffer",null);r(this,"earthIndexCount",0);r(this,"animationId",0);r(this,"isRunning",!1);r(this,"lastTime",0);r(this,"render",e=>{if(!this.isRunning||!this.context||!this.pipeline||!this.earthVertexBuffer||!this.earthIndexBuffer)return;const t=window.devicePixelRatio||1,s=Math.floor(this.canvas.clientWidth*t),i=Math.floor(this.canvas.clientHeight*t);(s!==this.canvas.width||i!==this.canvas.height)&&this.handleResize();const n=e*.001,a=Math.min(n-this.lastTime,.1);this.lastTime=n,this.profiler.beginFrame(e),this.writeUniforms(n,a);const h=this.context.createCommandEncoder("frame");this.pipeline.encodeComputePass(h),this.pipeline.encodeScenePass(h,this.earthVertexBuffer,this.earthIndexBuffer,this.earthIndexCount),this.pipeline.encodeBloomPasses(h);const m=this.context.getContext().getCurrentTexture().createView();this.pipeline.encodeCompositePass(h,m),this.context.submit([h.finish()]);const u=this.profiler.endFrame(e);u&&(u.visibleSatellites=this.estimateVisibleSatellites()),this.animationId=requestAnimationFrame(this.render)});const e=document.getElementById("gpu-canvas");if(!e)throw new Error("Canvas element #gpu-canvas not found");this.canvas=e,this.camera=new L,this.ui=new R,this.profiler=new _,this.setupCallbacks()}setupCallbacks(){this.camera.onModeChange((e,t,s)=>{this.ui.setViewMode(t,s),this.ui.setActiveButton(this.camera.getViewModeIndex())}),this.ui.onViewModeChange(e=>{this.camera.setViewMode(e)}),this.profiler.onStatsUpdate(e=>{this.ui.updateStats(e)})}async initialize(){try{console.log("[GrokZephyr] Initializing..."),this.context=new P(this.canvas);const{device:e}=await this.context.initialize();await this.profiler.initialize(e),this.camera.attachToCanvas(this.canvas),this.buffers=new A(this.context);const t=this.buffers.initialize();this.buffers.generateOrbitalElements(),this.buffers.uploadOrbitalElements(),this.createEarthGeometry(),this.pipeline=new I(this.context,t),this.handleResize(),this.ui.setFleetCount(f.NUM_SATELLITES),this.ui.hideError(),this.camera.setViewMode(0),this.start(),console.log("[GrokZephyr] Initialization complete")}catch(e){this.handleError(e)}}createEarthGeometry(){if(!this.context)return;const e=G(f.EARTH_RADIUS_KM,64,64);this.earthIndexCount=e.indices.length;const t=e.vertices.length/3,s=new Float32Array(t*6);for(let i=0;i<t;i++)s[i*6+0]=e.vertices[i*3+0],s[i*6+1]=e.vertices[i*3+1],s[i*6+2]=e.vertices[i*3+2],s[i*6+3]=e.normals[i*3+0],s[i*6+4]=e.normals[i*3+1],s[i*6+5]=e.normals[i*3+2];this.earthVertexBuffer=this.context.createVertexBuffer(s.byteLength),this.context.writeBuffer(this.earthVertexBuffer,s),this.earthIndexBuffer=this.context.createIndexBuffer(e.indices.byteLength),this.context.writeBuffer(this.earthIndexBuffer,e.indices)}handleResize(){if(!this.context||!this.buffers||!this.pipeline)return;const e=window.devicePixelRatio||1,t=Math.floor(this.canvas.clientWidth*e),s=Math.floor(this.canvas.clientHeight*e);this.context.resize(t,s),this.pipeline.resize(t,s),this.buffers.updateBloomUniforms(t,s)}writeUniforms(e,t){if(!this.context||!this.buffers)return;const{width:s,height:i}=this.context.getCanvasSize(),n=s/i,a=this.camera.calculateCamera((c,v)=>this.buffers.calculateSatellitePosition(c,v),(c,v)=>this.buffers.calculateSatelliteVelocity(c,v),e),{viewProjection:h,view:m}=this.camera.buildViewProjection(a,n),{right:u,up:g}=this.camera.getCameraAxes(m),p=z(h),y=new ArrayBuffer(B.UNIFORM),o=new Float32Array(y),w=new Uint32Array(y);o.set(h,0),o[16]=a.position[0],o[17]=a.position[1],o[18]=a.position[2],o[19]=1,o[20]=u[0],o[21]=u[1],o[22]=u[2],o[23]=0,o[24]=g[0],o[25]=g[1],o[26]=g[2],o[27]=0,o[28]=e,o[29]=t,w[30]=this.camera.getViewModeIndex(),w[31]=0;for(let c=0;c<6;c++)o[32+c*4+0]=p[c][0],o[32+c*4+1]=p[c][1],o[32+c*4+2]=p[c][2],o[32+c*4+3]=p[c][3];o[56]=s,o[57]=i,o[58]=0,o[59]=0,this.context.writeBuffer(this.buffers.getBuffers().uniforms,y)}estimateVisibleSatellites(){const e=this.camera.getViewModeIndex();return Math.floor(e===0?f.NUM_SATELLITES*.12:e===2?f.NUM_SATELLITES*.001:f.NUM_SATELLITES*.25)}start(){this.isRunning||(this.isRunning=!0,this.animationId=requestAnimationFrame(this.render))}stop(){this.isRunning=!1,cancelAnimationFrame(this.animationId)}handleError(e){console.error("[GrokZephyr] Error:",e);let t="Unknown error occurred";(e instanceof V||e instanceof Error)&&(t=e.message),this.ui.showError(t+"<br><br>Please use a modern browser with WebGPU enabled (Chrome 113+, Edge 113+, or Firefox Nightly).")}destroy(){var e,t,s,i,n;this.stop(),(e=this.pipeline)==null||e.destroy(),(t=this.buffers)==null||t.destroy(),(s=this.context)==null||s.destroy(),this.profiler.destroy(),(i=this.earthVertexBuffer)==null||i.destroy(),(n=this.earthIndexBuffer)==null||n.destroy()}}function M(){const l=new O;l.initialize().catch(console.error),window.addEventListener("beforeunload",()=>{l.destroy()}),window.zephyr=l}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",M):M();
//# sourceMappingURL=main-Bj8mPkGp.js.map

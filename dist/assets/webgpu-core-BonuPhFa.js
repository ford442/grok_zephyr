var M=Object.defineProperty;var T=(m,e,t)=>e in m?M(m,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[e]=t;var a=(m,e,t)=>T(m,typeof e!="symbol"?e+"":e,t);const d={NUM_SATELLITES:1048576,EARTH_RADIUS_KM:6371,ORBIT_RADIUS_KM:6921,CAMERA_RADIUS_KM:7091,MEAN_MOTION:.001097,NUM_PLANES:1024,SATELLITES_PER_PLANE:1024},p={DEG_TO_RAD:Math.PI/180},_=[53*p.DEG_TO_RAD,70*p.DEG_TO_RAD,97.6*p.DEG_TO_RAD,30*p.DEG_TO_RAD],I=[{id:0,name:"720km Horizon",altitude:"720",default:!0},{id:1,name:"God View",altitude:"---",default:!1},{id:2,name:"Fleet POV",altitude:"550",default:!1}],G={DEFAULT_FOV:60*p.DEG_TO_RAD,NEAR_PLANE:10,FAR_PLANE:5e4,GOD_VIEW_DISTANCE:25e3,GOD_VIEW_MIN_DISTANCE:8e3,GOD_VIEW_MAX_DISTANCE:6e4},D={HDR_FORMAT:"rgba16float",DEPTH_FORMAT:"depth24plus",SWAPCHAIN_FORMAT:"bgra8unorm",WORKGROUP_SIZE:64},O={FPS_UPDATE_INTERVAL:.5},E={UNIFORM:256,BLOOM_UNIFORM:32,SATELLITE_DATA:16,ORBITAL_ELEMENT:16};class A{constructor(e,t={}){a(this,"device",null);a(this,"adapter",null);a(this,"context",null);a(this,"format",D.SWAPCHAIN_FORMAT);a(this,"canvas");a(this,"options");a(this,"lostHandler",null);this.canvas=e,this.options={powerPreference:"high-performance",requiredFeatures:[],...t}}static isSupported(){return typeof navigator<"u"&&"gpu"in navigator}async initialize(){if(!A.isSupported())throw new c("WebGPU is not supported in this browser. Please use Chrome 113+, Edge 113+, or Firefox Nightly with WebGPU enabled.");try{if(this.adapter=await navigator.gpu.requestAdapter({powerPreference:this.options.powerPreference}),!this.adapter)throw new c("No WebGPU adapter found. Your GPU may not support WebGPU.");let e;if(this.adapter.info)e=this.adapter.info;else if(typeof this.adapter.requestAdapterInfo=="function")try{e=await this.adapter.requestAdapterInfo()}catch{}e&&console.log("[WebGPU] Adapter:",e.vendor,e.architecture);const t=d.NUM_SATELLITES*16+16;if(this.device=await this.adapter.requestDevice({requiredFeatures:this.options.requiredFeatures,requiredLimits:{maxStorageBufferBindingSize:Math.min(this.adapter.limits.maxStorageBufferBindingSize,t),maxBufferSize:Math.min(this.adapter.limits.maxBufferSize,t),...this.options.requiredLimits}}),this.lostHandler=i=>{console.error("[WebGPU] Device lost:",i.reason,i.message),i.reason==="destroyed"?console.log("[WebGPU] Device was intentionally destroyed"):(console.log("[WebGPU] Attempting to reinitialize..."),this.initialize().catch(console.error))},this.device.lost.then(this.lostHandler),this.context=this.canvas.getContext("webgpu"),!this.context)throw new c("Failed to create WebGPU canvas context");return this.format=navigator.gpu.getPreferredCanvasFormat(),this.context.configure({device:this.device,format:this.format,alphaMode:"opaque",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST}),console.log("[WebGPU] Context initialized successfully"),console.log(`[WebGPU] Format: ${this.format}`),console.log(`[WebGPU] Max storage buffer: ${this.device.limits.maxStorageBufferBindingSize} bytes`),{device:this.device,adapter:this.adapter,context:this.context,format:this.format,presentationFormat:this.format}}catch(e){throw e instanceof c?e:new c(`Failed to initialize WebGPU: ${e instanceof Error?e.message:String(e)}`)}}getDevice(){if(!this.device)throw new c("WebGPU not initialized. Call initialize() first.");return this.device}getAdapter(){if(!this.adapter)throw new c("WebGPU not initialized. Call initialize() first.");return this.adapter}getContext(){if(!this.context)throw new c("WebGPU not initialized. Call initialize() first.");return this.context}getFormat(){return this.format}createShaderModule(e,t){const r=this.getDevice().createShaderModule({code:e,label:t});return r.getCompilationInfo().then(s=>{for(const o of s.messages){const n=`[Shader${o.lineNum>0?`:${o.lineNum}:${o.linePos}`:""}] ${o.message}`;o.type==="error"?console.error(n):o.type==="warning"?console.warn(n):console.log(n)}}),r}createBuffer(e,t,i=!1){const r=this.getDevice(),s=t&GPUBufferUsage.UNIFORM?Math.ceil(e/256)*256:e;return r.createBuffer({size:s,usage:t,mappedAtCreation:i})}createUniformBuffer(e){return this.createBuffer(e,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST)}createStorageBuffer(e,t=!1){const i=GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST;return t?this.createBuffer(e,i):this.createBuffer(e,i|GPUBufferUsage.COPY_SRC)}createVertexBuffer(e){return this.createBuffer(e,GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST)}createIndexBuffer(e){return this.createBuffer(e,GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST)}writeBuffer(e,t,i=0){this.getDevice().queue.writeBuffer(e,i,t)}createTexture(e,t,i,r,s){return this.getDevice().createTexture({size:[e,t],format:i,usage:r|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT,label:s})}createLinearSampler(){return this.getDevice().createSampler({magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"})}createCommandEncoder(e){return this.getDevice().createCommandEncoder({label:e})}submit(e){this.getDevice().queue.submit(e)}resize(e,t){(this.canvas.width!==e||this.canvas.height!==t)&&(this.canvas.width=e,this.canvas.height=t)}getCanvasSize(){return{width:this.canvas.width,height:this.canvas.height}}async isFeatureSupported(e){if(!this.adapter)throw new c("WebGPU not initialized");return this.adapter.features.has(e)}destroy(){this.device&&(this.device.destroy(),this.device=null),this.adapter=null,this.context=null,this.lostHandler=null}}class c extends Error{constructor(e){super(e),this.name="WebGPUError"}}class w{constructor(e,t={}){a(this,"context");a(this,"config");a(this,"buffers",null);a(this,"orbitalElementData");a(this,"numSatellites");a(this,"positionBufferSize");a(this,"elementBufferSize");this.context=e,this.config={doubleBuffer:!1,enableReadback:!1,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST,...t},this.numSatellites=d.NUM_SATELLITES,this.positionBufferSize=this.numSatellites*E.SATELLITE_DATA,this.elementBufferSize=this.numSatellites*E.ORBITAL_ELEMENT,this.orbitalElementData=new Float32Array(this.numSatellites*4)}initialize(){console.log(`[SatelliteGPUBuffer] Initializing buffers for ${this.numSatellites.toLocaleString()} satellites`),console.log(`[SatelliteGPUBuffer] Position buffer: ${(this.positionBufferSize/1024/1024).toFixed(2)} MB`),console.log(`[SatelliteGPUBuffer] Element buffer: ${(this.elementBufferSize/1024/1024).toFixed(2)} MB`);const e=this.context.createBuffer(this.elementBufferSize,GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST);let t;this.config.doubleBuffer?t={read:this.context.createStorageBuffer(this.positionBufferSize),write:this.context.createStorageBuffer(this.positionBufferSize),current:"read"}:t=this.context.createStorageBuffer(this.positionBufferSize);const i=this.context.createUniformBuffer(E.UNIFORM),r={horizontal:this.context.createUniformBuffer(E.BLOOM_UNIFORM),vertical:this.context.createUniformBuffer(E.BLOOM_UNIFORM)};return this.buffers={orbitalElements:e,positions:t,uniforms:i,bloomUniforms:r},this.buffers}generateOrbitalElements(){const{NUM_PLANES:e,SATELLITES_PER_PLANE:t}=d,i=_;console.log("[SatelliteGPUBuffer] Generating orbital elements...");const r=performance.now();for(let o=0;o<e;o++){const f=o/e*Math.PI*2,n=Math.floor(o/(e/i.length)),h=i[n]+(Math.random()-.5)*.008;for(let l=0;l<t;l++){const u=(o*t+l)*4,g=l/t*Math.PI*2;this.orbitalElementData[u+0]=f,this.orbitalElementData[u+1]=h,this.orbitalElementData[u+2]=g,this.orbitalElementData[u+3]=Math.floor(o*7/e)}}const s=performance.now()-r;return console.log(`[SatelliteGPUBuffer] Generated elements in ${s.toFixed(2)}ms`),this.orbitalElementData}uploadOrbitalElements(){if(!this.buffers)throw new Error("Buffers not initialized. Call initialize() first.");this.context.writeBuffer(this.buffers.orbitalElements,this.orbitalElementData)}updateBloomUniforms(e,t){if(!this.buffers)return;const i=r=>{const s=new ArrayBuffer(32),o=new Float32Array(s),f=new Uint32Array(s);return o[0]=1/e,o[1]=1/t,f[2]=r?1:0,f[3]=0,s};this.context.writeBuffer(this.buffers.bloomUniforms.horizontal,i(!0)),this.context.writeBuffer(this.buffers.bloomUniforms.vertical,i(!1))}getPositionBufferForRender(){if(!this.buffers)throw new Error("Buffers not initialized");return this.isBufferPair(this.buffers.positions)?this.buffers.positions.current==="read"?this.buffers.positions.read:this.buffers.positions.write:this.buffers.positions}getPositionBufferForCompute(){if(!this.buffers)throw new Error("Buffers not initialized");return this.isBufferPair(this.buffers.positions)?this.buffers.positions.current==="read"?this.buffers.positions.write:this.buffers.positions.read:this.buffers.positions}swapBuffers(){!this.buffers||!this.isBufferPair(this.buffers.positions)||(this.buffers.positions.current=this.buffers.positions.current==="read"?"write":"read")}getBuffers(){if(!this.buffers)throw new Error("Buffers not initialized. Call initialize() first.");return this.buffers}getOrbitalElementData(){return this.orbitalElementData}calculateSatellitePosition(e,t){const i=e*4,r=this.orbitalElementData[i],s=this.orbitalElementData[i+1],f=this.orbitalElementData[i+2]+d.MEAN_MOTION*t,n=Math.cos(f),h=Math.sin(f),l=Math.cos(r),u=Math.sin(r),g=Math.cos(s),B=Math.sin(s);return[d.ORBIT_RADIUS_KM*(l*n-u*h*g),d.ORBIT_RADIUS_KM*(u*n+l*h*g),d.ORBIT_RADIUS_KM*h*B]}calculateSatelliteVelocity(e,t){const i=e*4,r=this.orbitalElementData[i],s=this.orbitalElementData[i+1],f=this.orbitalElementData[i+2]+d.MEAN_MOTION*t,n=Math.cos(f),h=Math.sin(f),l=Math.cos(r),u=Math.sin(r),g=Math.cos(s),B=Math.sin(s),b=-(l*h+u*n*g),U=-(u*h-l*n*g),S=n*B,P=Math.sqrt(b*b+U*U+S*S)||1;return[b/P,U/P,S/P]}async readbackPositions(){if(!this.buffers||!this.config.enableReadback)return null;const e=this.context.getDevice(),t=this.getPositionBufferForRender(),i=e.createBuffer({size:this.positionBufferSize,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),r=e.createCommandEncoder();r.copyBufferToBuffer(t,0,i,0,this.positionBufferSize),e.queue.submit([r.finish()]),await i.mapAsync(GPUMapMode.READ);const s=new Float32Array(i.getMappedRange().slice(0));return i.unmap(),i.destroy(),s}getMemoryUsage(){let e=this.elementBufferSize+E.UNIFORM+E.BLOOM_UNIFORM*2;return this.config.doubleBuffer&&this.buffers&&this.isBufferPair(this.buffers.positions)?e+=this.positionBufferSize*2:e+=this.positionBufferSize,e}destroy(){this.buffers&&(this.buffers.orbitalElements.destroy(),this.buffers.uniforms.destroy(),this.buffers.bloomUniforms.horizontal.destroy(),this.buffers.bloomUniforms.vertical.destroy(),this.isBufferPair(this.buffers.positions)?(this.buffers.positions.read.destroy(),this.buffers.positions.write.destroy()):this.buffers.positions.destroy(),this.buffers=null)}isBufferPair(e){return"read"in e&&"write"in e}}export{E as B,d as C,D as R,w as S,O as U,I as V,A as W,G as a,c as b};
//# sourceMappingURL=webgpu-core-BonuPhFa.js.map
